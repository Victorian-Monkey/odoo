# =============================================================================
# TRAEFIK DYNAMIC CONFIGURATION
# =============================================================================

http:
  # ===========================================================================
  # MIDDLEWARES
  # ===========================================================================
  middlewares:
    # Security Headers
    security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        stsIncludeSubdomains: true
        stsSeconds: 31536000
        stsPreload: true
        referrerPolicy: "strict-origin-when-cross-origin"
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Robots-Tag: "none,noarchive,nosnippet,notranslate,noimageindex"
          server: ""
          X-Powered-By: ""

    # Redirect HTTP to HTTPS
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # Rate Limiting - Protezione da abusi
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # BasicAuth per Prometheus (cambia password!)
    prometheus-auth:
      basicAuth:
        users:
          # Username: admin, Password: changeme
          # Genera una nuova con: htpasswd -nb admin yourpassword
          - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"

    # BasicAuth per Grafana (opzionale, Grafana ha già il suo login)
    grafana-auth:
      basicAuth:
        users:
          # Username: admin, Password: changeme
          # Genera una nuova con: htpasswd -nb admin yourpassword
          - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"

    # Compress responses
    compress:
      compress: {}

    # IP Whitelist (opzionale - decommentare e configurare se necessario)
    # ip-whitelist:
    #   ipWhiteList:
    #     sourceRange:
    #       - "127.0.0.1/32"
    #       - "192.168.1.0/24"
    #       - "your-office-ip/32"

  # ===========================================================================
  # ROUTERS (HTTP → HTTPS Redirect)
  # ===========================================================================
  routers:
    # Redirect globale HTTP → HTTPS
    http-catchall:
      rule: "HostRegexp(`{host:.+}`)"
      entryPoints:
        - web
      middlewares:
        - https-redirect
      service: noop@internal

    # Traefik Dashboard (opzionale, protetto con BasicAuth)
    traefik-dashboard:
      rule: "Host(`traefik.victorianmonkey.org`)"
      entryPoints:
        - websecure
      middlewares:
        - prometheus-auth
        - security-headers
      service: api@internal
      tls:
        certResolver: le

  # ===========================================================================
  # SERVICES
  # ===========================================================================
  # services:
  # Eventuali servizi custom qui
# =============================================================================
# TCP CONFIGURATION (opzionale)
# =============================================================================
# tcp:
#   routers:
#     postgres:
#       rule: "HostSNI(`*`)"
#       entryPoints:
#         - postgres
#       service: postgres
#   services:
#     postgres:
#       loadBalancer:
#         servers:
#           - address: "db.example.com:5432"

# GitLab CI/CD Pipeline per modulo Odoo
# Esegue: compilazione, test, e creazione ZIP per tutti i branch e tag

stages:
  - build
  - test
  - package

variables:
  ODOO_VERSION: "19.0"
  MODULE_NAME: "associazioni-culturali"
  DB_NAME: "test_${CI_COMMIT_REF_SLUG}_${CI_PIPELINE_ID}"

# Job di compilazione (per eventuali file compilabili)
# Attualmente il modulo è solo Python, ma questo stage è pronto per future estensioni
compile:
  stage: build
  image: python:3.11-slim
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
  script:
    - echo "Verifica struttura del modulo..."
    - |
      if [ -f "package.json" ]; then
        echo "Trovato package.json, installazione dipendenze..."
        npm install
        npm run build || true
      fi
    - |
      if [ -f "requirements.txt" ]; then
        echo "Trovato requirements.txt, installazione dipendenze Python..."
        pip install -r requirements.txt || true
      fi
    - echo "Compilazione completata (nessun file compilabile trovato)"
  artifacts:
    when: always
    expire_in: 1 hour

# Job di test
test:
  stage: test
  image: odoo:${ODOO_VERSION}
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
  services:
    - postgres:13
  variables:
    POSTGRES_DB: "${DB_NAME}"
    POSTGRES_USER: "odoo"
    POSTGRES_PASSWORD: "odoo"
    PGDATA: "/var/lib/postgresql/data/pgdata"
  before_script:
    - apt-get update -qq && apt-get install -y -qq git postgresql-client || true
    - |
      # Crea file di configurazione Odoo minimale
      cat > /tmp/odoo.conf << EOF
      [options]
      addons_path = /mnt/extra-addons,/usr/lib/python3/dist-packages/odoo/addons
      admin_passwd = admin
      csv_internal_sep = ,
      db_host = postgres
      db_maxconn = 64
      db_name = ${DB_NAME}
      db_password = odoo
      db_port = 5432
      db_template = template1
      db_user = odoo
      dbfilter = ${DB_NAME}
      email_from = False
      http_interface = 
      http_port = 8069
      limit_memory_hard = 2684354560
      limit_memory_soft = 2147483648
      limit_request = 8192
      limit_time_cpu = 600
      limit_time_real = 1200
      list_db = True
      log_db = False
      log_db_level = warning
      log_handler = :INFO
      log_level = info
      logfile = False
      max_cron_threads = 2
      osv_memory_age_limit = 1.0
      osv_memory_count_limit = False
      proxy_mode = False
      reportgz = False
      server_wide_modules = base,web
      smtp_password = False
      smtp_port = 25
      smtp_server = localhost
      smtp_ssl = False
      smtp_user = False
      translate_modules = ['all']
      unaccent = False
      without_demo = all
      workers = 0
      xmlrpc = True
      xmlrpc_interface = 
      xmlrpc_port = 8069
      EOF
    - |
      # Copia il modulo nella directory addons
      mkdir -p /mnt/extra-addons
      cp -r . /mnt/extra-addons/${MODULE_NAME}
      cd /mnt/extra-addons/${MODULE_NAME}
      # Rimuovi file non necessari per i test
      rm -rf .git .gitlab-ci.yml || true
    - |
      # Attendi che PostgreSQL sia pronto
      until pg_isready -h postgres -U odoo; do
        echo "Attesa PostgreSQL..."
        sleep 2
      done
  script:
    - |
      echo "Creazione database di test..."
      # Crea il database (se non esiste già)
      PGPASSWORD=odoo createdb -h postgres -U odoo ${DB_NAME} || true
      
      echo "Installazione del modulo con test..."
      # Installa il modulo ed esegui i test
      # Usa odoo-bin se disponibile, altrimenti odoo
      ODOO_CMD=$(which odoo-bin 2>/dev/null || which odoo 2>/dev/null || echo "odoo")
      
      set +e
      ${ODOO_CMD} -c /tmp/odoo.conf \
        -d ${DB_NAME} \
        --stop-after-init \
        --test-enable \
        --log-level=test \
        -u ${MODULE_NAME} \
        --without-demo=all
      TEST_EXIT_CODE=$?
      set -e
      
      # Verifica se i test sono passati
      if [ "$TEST_EXIT_CODE" -ne 0 ]; then
        echo "I test sono falliti con codice: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      fi
      
      echo "Test completati con successo!"
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - test_results/
    reports:
      junit: test_results/junit.xml
  allow_failure: false

# Job di creazione ZIP
package:
  stage: package
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
  dependencies:
    - compile
    - test
  before_script:
    - apk add --no-cache zip
  script:
    - |
      echo "Creazione ZIP del modulo..."
      
      # Determina il nome del file ZIP basato su branch/tag
      if [ -n "$CI_COMMIT_TAG" ]; then
        ZIP_NAME="${MODULE_NAME}_${CI_COMMIT_TAG}.zip"
      else
        ZIP_NAME="${MODULE_NAME}_${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHORT_SHA}.zip"
      fi
      
      # Estrai versione dal manifest
      VERSION=$(grep -E "^[[:space:]]*'version':" __manifest__.py | sed "s/.*'version':[[:space:]]*'\([^']*\)'.*/\1/" || echo 'unknown')
      
      # Crea lo ZIP escludendo file non necessari
      zip -r ${ZIP_NAME} . \
        -x ".git/*" \
        -x ".gitlab-ci.yml" \
        -x ".gitignore" \
        -x "*/__pycache__/*" \
        -x "*.pyc" \
        -x "*.pyo" \
        -x "*/.pytest_cache/*" \
        -x ".coverage" \
        -x "*/htmlcov/*" \
        -x "*/.tox/*" \
        -x "*/.venv/*" \
        -x "*/venv/*" \
        -x "*/env/*" \
        -x "*/node_modules/*" \
        -x ".DS_Store" \
        -x "*.swp" \
        -x "*.swo" \
        -x "*~" \
        -x "*/.idea/*" \
        -x "*/.vscode/*" \
        -x "*.log" \
        -x "*/test_results/*"
      
      echo "ZIP creato: ${ZIP_NAME}"
      ls -lh ${ZIP_NAME}
      
      # Mostra il contenuto del modulo nel ZIP
      echo "Contenuto del modulo nel ZIP (prime 30 righe):"
      unzip -l ${ZIP_NAME} | head -30
      
      # Crea file con informazioni sul package
      cat > package.env << EOF
      PACKAGE_NAME=${ZIP_NAME}
      MODULE_NAME=${MODULE_NAME}
      VERSION=${VERSION}
      PACKAGE_PATH=${ZIP_NAME}
      EOF
  artifacts:
    when: on_success
    expire_in: 30 days
    paths:
      - "*.zip"
      - "package.env"
    reports:
      dotenv: package.env
